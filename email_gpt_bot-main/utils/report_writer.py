import os
from datetime import datetime
from pathlib import Path
from openai import OpenAI



def parse_gpt_reply(text):
    result = {"summary": "", "important": "", "need_reply": "", "category": ""}
    lines = text.strip().split("\n")
    for line in lines:
        if ":" in line:
            key, val = line.split(":", 1)
            key = key.strip().lower()
            val = val.strip()

            if any(k in key for k in ["æ‘˜è¦", "summary"]):
                result["summary"] = val
            elif any(k in key for k in ["é‡è¦", "importance"]):
                result["important"] = val
            elif any(k in key for k in ["å›è¦†", "reply"]):
                result["need_reply"] = val
            elif any(k in key for k in ["åˆ†é¡", "category"]):
                result["category"] = val
    return result


def write_markdown_report(emails, summaries, output_dir="output", api_key=None):
    today = datetime.today().strftime("%Y-%m-%d")
    Path(output_dir).mkdir(parents=True, exist_ok=True)
    md_path = os.path.join(output_dir, f"{today}.md")

    client = OpenAI(api_key=api_key)
    print("ğŸ§¾ summaries length:", len(summaries))
    print("ğŸ§¾ First item of summaries:", summaries[0] if summaries else "ç©º")
    print("ğŸ§¾ Sending to GPT:\n", "\n\n".join(summaries)[:1000])  # é¡¯ç¤ºå‰ 1000 å­—

    try:
        final_response = client.chat.completions.create(
            model="gpt-4o-2024-08-06",
            messages=[
                {
                    "role": "system",
                    "content": (
                        "ä½ æ˜¯ä¸€ä½å°ˆæ¥­éƒµä»¶åŠ©ç†ï¼Œè«‹æ ¹æ“šæä¾›çš„ä¿¡ä»¶æ‘˜è¦ï¼Œæ•´ç†å‡ºä¸€ç¯‡åƒé›»å­å ±èˆ¬ç²¾ç¾ã€çµæ§‹è‰¯å¥½ä¸”è³‡è¨Šæ¿ƒç¸®çš„ Markdown å ±å‘Šã€‚\n\n"
                        "è«‹ä¾ä»¥ä¸‹åŸå‰‡æ•´ç†ï¼š\n"
                        "0. å ±å‘Šé–‹é ­è«‹ä»¥å±¬ä¸‹èº«ä»½å‘ Patrick å‘ˆå ±ï¼Œæ•´é«”é¢¨æ ¼é¡ä¼¼ä¸€ä»½å…¬å¸å…§éƒ¨ç²¾ç¾é›»å­å ±ã€‚å ±å‘Šé–‹é ­éœ€åŒ…å«ä¸€æ®µç´„ 100 å­—å·¦å³çš„å°è¨€ï¼Œæ–‡ä¸­å¯åŠ å…¥å•å€™èªï¼ˆå¦‚ã€Œè¦ªæ„›çš„ Patrickã€ï¼‰ï¼Œä¸¦ä»¥æ­£å¼ä½†ä¸å¤±æº«åº¦çš„èªæ°£å‘ˆç¾ä»Šæ—¥ä¾†ä¿¡çš„æ•´é«”è¶¨å‹¢èˆ‡é‡é»äº‹é …ï¼Œå¼·èª¿é‡è¦é€šçŸ¥èˆ‡éœ€è¦å›è¦†çš„éƒµä»¶ã€‚é©åº¦åŠ å…¥é†’ç›®çš„ç²—é«”å­—ä»¥å¢åŠ è¦–è¦ºæ•ˆæœã€‚\n"
                        "1. å ±å‘Šæ¨™é¡Œï¼šã€ğŸ“¬ ä»Šæ—¥éƒµä»¶æ‘˜è¦ã€ã€‚\n"
                        "2. å ±å‘Šå…§æ–‡è«‹ä¾ç…§ä»¥ä¸‹å€å¡Šåˆ†é¡ï¼Œä¸¦ä¾é‡è¦æ€§é †åºæ•´ç†ï¼ˆå¦‚é‡åˆ°é‡è¤‡ä¸»é¡Œçš„éƒµä»¶è«‹åˆä½µé‡é»ï¼‰ï¼š\n"
                        "   - **ğŸ“© éœ€è¦å›è¦†çš„éƒµä»¶**ï¼šåŒ…å«åŠ©æ•™ã€æœƒè­°ã€åˆä½œææ¡ˆç­‰å¿…é ˆå›è¦†çš„è¨Šæ¯ã€‚\n"
                        "   - **âœ‰ï¸ å„ªå…ˆé€šçŸ¥**ï¼šæ¶‰åŠå­¸æ¥­ã€è€ƒè©¦ã€æ ¡å‹™ã€å ±åç­‰é‡è¦äº‹å‹™çš„éƒµä»¶ï¼Œæˆ–æœ‰æ˜ç¢ºæé†’å¿…é ˆæ³¨æ„çš„äº‹é …ã€‚\n"
                        "   - **ğŸ“¢ æ¨å»£èˆ‡æ¼”è¬›è³‡è¨Š**ï¼šèˆ‡ç ”è¨æœƒã€æ´»å‹•é‚€è«‹æˆ–è¬›åº§é€šçŸ¥ç›¸é—œçš„éƒµä»¶ï¼Œä½†ç„¡éœ€ç«‹å³å›è¦†ã€‚\n"
                        "   - **ğŸ—‚ å…¶ä»–é€šçŸ¥**ï¼šåŒ…æ‹¬ç³»çµ±é€šçŸ¥ã€å¸³æˆ¶æé†’ã€æ¶ˆæ¯å…¬å‘Šç­‰å…¶ä»–è³‡è¨Šï¼Œè«‹ä¾ç…§é‡è¦ç¨‹åº¦æ’åºã€‚\n"
                        "3. æ¯å°éƒµä»¶çš„å…§å®¹æ ¼å¼è«‹çµ±ä¸€ç‚ºï¼š\n"
                        "   - **ä¸»æ—¨ï¼š** ï¼ˆå¯ç°¡åŒ–ï¼‰\n"
                        "   - **ğŸ“¬ æ”¶ä»¶ä¿¡ç®±ï¼š** xxx@xxx.com\n"
                        "   - **æ¿ƒç¸®æ‘˜è¦ï¼š** ï¼ˆç°¡æ˜æ‰¼è¦ï¼Œå»ºè­°ä¸è¶…é 30 å­—ï¼‰\n"
                        "   - **ç›¸é—œéˆçµï¼š** (è‹¥æœ‰å†æä¾›)\n"
                        "4. è«‹æ³¨æ„æ’ç‰ˆèˆ‡è¦–è¦ºæ•ˆæœï¼Œåˆ†æ®µæ¸…æ™°ä¸”é¿å…å†—é•·ï¼Œå‹™å¿…æå‡å ±å‘Šçš„æ˜“è®€æ€§èˆ‡å¸å¼•åŠ›ã€‚\n\n"
                        "è«‹ä¾ä¸‹åˆ—æ¨¡æ¿æ’°å¯«å ±å‘Šï¼š\n"
                        "## ä»Šæ—¥æ‘˜è¦\n"
                        "ï¼ˆä»¥ä¸Šå±¬ä¸‹å£å»æ’°å¯«ç´„ 100 å­—çš„æ‘˜è¦ï¼Œæ¦‚è¿°ä»Šæ—¥ä¸»è¦ä¾†ä¿¡è¶¨å‹¢èˆ‡é‡é»ä»»å‹™ï¼Œä¸¦å¼·èª¿é‡è¦é€šçŸ¥èˆ‡éœ€è¦å›è¦†çš„äº‹é …ï¼‰\n\n"
                        "## ğŸ“© éœ€è¦å›è¦†çš„éƒµä»¶\n"
                        "- **ä¸»æ—¨ï¼š** xxx  \n"
                        "  **ğŸ“¬ æ”¶ä»¶ä¿¡ç®±ï¼š** xxx@xxx.com  \n"
                        "  **æ¿ƒç¸®æ‘˜è¦ï¼š** xxx\n\n"
                        "## âœ‰ï¸ å„ªå…ˆé€šçŸ¥\n"
                        "- **ä¸»æ—¨ï¼š** xxx  \n"
                        "  **ğŸ“¬ æ”¶ä»¶ä¿¡ç®±ï¼š** xxx@xxx.com  \n"
                        "  **æ¿ƒç¸®æ‘˜è¦ï¼š** xxx\n\n"
                        "## ğŸ“¢ æ¨å»£èˆ‡æ¼”è¬›è³‡è¨Š\n"
                        "- **ä¸»æ—¨ï¼š** xxx  \n"
                        "  **ğŸ“¬ æ”¶ä»¶ä¿¡ç®±ï¼š** xxx@xxx.com  \n"
                        "  **æ¿ƒç¸®æ‘˜è¦ï¼š** xxx\n\n"
                        "## ğŸ—‚ å…¶ä»–é€šçŸ¥\n"
                        "- **ä¸»æ—¨ï¼š** xxx  \n"
                        "  **ğŸ“¬ æ”¶ä»¶ä¿¡ç®±ï¼š** xxx@xxx.com  \n"
                        "  **æ¿ƒç¸®æ‘˜è¦ï¼š** xxx\n"
                        "---\n"
                        "ï¼ˆé™„ä¸Šçµèªï¼Œè¬è¬é–±è®€ï¼Œä¸¦æé†’é—œæ³¨å¾ŒçºŒé‡é»æ›´æ–°ã€‚ï¼‰"
                    )
                },
                {
                    "role": "user",
                    "content": "ä»¥ä¸‹æ˜¯ä»Šå¤©æ”¶åˆ°çš„ä¿¡ä»¶æ‘˜è¦ï¼Œæ¯å°ä¿¡å¯èƒ½åŒ…å«ï¼šä¸»æ—¨ã€ä¾†æºä¿¡ç®±ã€æ‘˜è¦ã€æ˜¯å¦éœ€è¦å›è¦†ã€æ˜¯å¦ç‚ºæ¨éŠ·ã€æ˜¯å¦åŒ…å«é‡è¦è³‡è¨Šã€è‡ªç”±åˆ†é¡ï¼š\n\n" + "\n\n".join(summaries)
                }
            ],
            temperature=0.4,
            max_tokens=5000
        )
        report = final_response.choices[0].message.content
        print("ğŸ“ GPT å›å‚³å…§å®¹å‰ 300 å­—ï¼š", report[:300])
        print("ğŸ“ å›å‚³å…§å®¹æ˜¯å¦ç‚ºç©ºï¼š", "æ˜¯ç©ºçš„" if not report.strip() else "âœ… æœ‰å…§å®¹")
    except Exception as e:
        report = f"# éƒµä»¶æ•´ç†å¤±æ•—\n\nåŸå› ï¼š{e}"

    with open(md_path, "w", encoding="utf-8") as f:
        f.write(report if report.strip() else "# âš ï¸ GPT å›å‚³å…§å®¹ç‚ºç©º")

    return report
